// Copyright (C) 2019 Czech Technical University.
// All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are
// met:
//
//     * Redistributions of source code must retain the above copyright
//       notice, this list of conditions and the following disclaimer.
//
//     * Redistributions in binary form must reproduce the above
//       copyright notice, this list of conditions and the following
//       disclaimer in the documentation and/or other materials provided
//       with the distribution.
//
//     * Neither the name of Czech Technical University nor the
//       names of its contributors may be used to endorse or promote products
//       derived from this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
// AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
// ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE
// LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
// CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
// SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
// INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
// CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
// ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
// POSSIBILITY OF SUCH DAMAGE.
//
// Please contact the author of this library if you have any questions.
// Author: Daniel Barath (barath.daniel@sztaki.mta.hu)
#pragma once

#include "solver_engine.h"
#include <iostream>

namespace gcransac
{
	namespace estimator
	{
		namespace solver
		{
			// This is the estimator class for estimating a homography matrix between two images. A model estimation method and error calculation method are implemented
			class EllipseP2N2C1BasedSolver : public SolverEngine
			{
			public:
				EllipseP2N2C1BasedSolver()
				{
				}

				~EllipseP2N2C1BasedSolver()
				{
				}

				// Determines if there is a chance of returning multiple models
				// when function 'estimateModel' is applied.
				static constexpr bool returnMultipleModels()
				{
					return maximumSolutions() > 1;
				}

				// The maximum number of solutions returned by the estimator
				static constexpr size_t maximumSolutions()
				{
					return 5;
				}

				// The minimum number of points required for the estimation
				static constexpr size_t sampleSize()
				{
					return 2;
				}

				// It returns true/false depending on if the solver needs the gravity direction
				// for the model estimation. 
				static constexpr bool needsGravity()
				{
					return false;
				}

				OLGA_INLINE bool estimateModel(
					const cv::Mat& data_, // The set of data points
					const size_t *sample_, // The sample used for the estimation
					size_t sample_number_, // The size of the sample
					std::vector<Model> &models_, // The estimated model parameters
					const double *weights_ = nullptr) const; // The weight for each point

			protected:
				OLGA_INLINE bool fitEllipseFrom3Points(
					const cv::Mat& data_,
					const size_t *sample_,
					size_t sample_number_,
					std::vector<Model> &models_,
					const double *weights_) const;
					
				OLGA_INLINE bool fitEllipseFromNPoints(
					const cv::Mat& data_,
					const size_t *sample_,
					size_t sample_number_,
					std::vector<Model> &models_,
					const double *weights_) const;

				OLGA_INLINE bool normalizePoints(
					const cv::Mat& data_, // The set of data points
					cv::Mat& normalized_data_, // The normalized data points
					double &x_mean_, // The mean of the x coordinates
					double &y_mean_, // The mean of the y coordinates
					double &x_stddev_, // The standard deviation of the x coordinates
					double &y_stddev_, // The standard deviation of the y coordinates
					const size_t *sample_, // The sample used for the estimation
					size_t sample_number_) const; // The size of the sample
					
				OLGA_INLINE bool getConicCenter(
					double A, double B, double C, double D, double E,
					double &xc, double &yc) const;

				OLGA_INLINE bool getConicAxes(
					double A, double B, double C, double D, double E, double F,
					double x0, double y0,
					double &a, double &b,
					double &orientation) const;

					
				Eigen::MatrixXcd solver_ellipse_2PGC(const Eigen::VectorXd& data) const;
				
				OLGA_INLINE void ellipseParamToConic(
					double xc, double yc,
					double a_major, double a_minor,
					double phi,
					// Output: conic parameters
					double &A, double &B, double &C, double &D, double &E, double &F) const;
			};

			OLGA_INLINE bool EllipseP2N2C1BasedSolver::getConicAxes(
				double A, double B, double C, double D, double E, double F,
				double x0, double y0,
				double &a, double &b,
				double &orientation) const
			{
				// 1) Translate x -> X+x0, y->Y+y0 => get new eq in X,Y:
				//    A'X^2 + B'X Y + C'Y^2 + F' = 0, no linear terms if (x0,y0) is correct center.
				//
				// Let's do that explicitly by substituting x=X+x0, y=Y+y0 in the original eq
				// For a short snippet, we can do it manually or systematically:
				//   Expand => gather X^2, X Y, Y^2, constant => A',B',C',F'.
				// For brevity, let's do a direct approach.

				// SHIFT:
				// x = X + x0, y = Y + y0
				// x^2 => X^2 + 2 x0 X + x0^2, etc.

				// We'll define short helpers:
				auto sq = [](double v){return v*v;};

				// Coeff. of X^2: A'
				double A_prime = A; 
				// Coeff. of X Y: B_prime
				double B_prime = B; 
				// Coeff. of Y^2: C_prime
				double C_prime = C;

				// Now there's a cross-term from X^2 if we expand D*x = D*(X+x0), etc.
				// But we expect the linear terms vanish if (x0,y0) is truly the center.
				// The only leftover constant term is:
				//
				// F' = A*x0^2 + B*x0*y0 + C*y0^2 + D*x0 + E*y0 + F
				// because the boundary eq at (X,Y) => 0 => must match the old eq => 0 at (x,y).
				double F_prime = A*sq(x0) + B*x0*y0 + C*sq(y0)
							+ D*x0 + E*y0 + F; // no negative sign yet

				// If the ellipse is correctly centered, there should be no linear X or Y left.
				// We skip verifying that here. If not zero, x0,y0 wasn't correct.

				// 2) We want a factor alpha so alpha*(A'X^2 + B'X Y + C'Y^2) = 1 on the boundary.
				// The boundary in the new coords satisfies A'X^2 + B'X Y + C'Y^2 + F' = 0 => 
				// => A'X^2 + B'X Y + C'Y^2 = -F'.
				// So define alpha = 1 / (-F')  (assuming F'<0 for typical ellipse).
				// That yields alpha*(A'X^2 + B'X Y + C'Y^2) = 1.
				if (std::fabs(F_prime) < 1e-14) {
					std::cerr << "Degenerate or invalid center => cannot compute axes.\n";
					return false;
				}

				double signF = (F_prime < 0.0) ? -1.0 : +1.0; // typically F'<0 => signF = -1
				double alpha = 1.0 / (-F_prime); // if F' < 0, alpha>0 => valid

				// 3) Build the 2x2 matrix Q = alpha * [[A', B'/2],[B'/2, C']]
				//    Then we find the eigenvalues => 1/a^2, 1/b^2.
				Eigen::Matrix2d Q;
				Q << alpha*A_prime, alpha*(B_prime*0.5),
					alpha*(B_prime*0.5), alpha*C_prime;

				// 4) Eigen decomposition
				Eigen::SelfAdjointEigenSolver<Eigen::Matrix2d> es(Q);
				if (es.info() != Eigen::Success) {
					std::cerr << "Eigen decomposition failed.\n";
					return false;
				}

				// The eigenvalues => lam1, lam2
				double lam1 = es.eigenvalues()(0);
				double lam2 = es.eigenvalues()(1);

				// If either is <= 0 => not an ellipse
				if (lam1 <= 1e-14 || lam2 <= 1e-14) {
					std::cerr << "Not an ellipse or degenerate.\n";
					return false;
				}

				double axis1 = std::sqrt(1.0 / lam1);
				double axis2 = std::sqrt(1.0 / lam2);

				// The corresponding eigenvectors
				Eigen::Vector2d evec1 = es.eigenvectors().col(0); // normalized
				Eigen::Vector2d evec2 = es.eigenvectors().col(1);

				// 5) Identify which eigenvalue => major axis vs. minor axis
				//    lam1 < lam2 => axis1 > axis2 => axis1 is the major axis
				//    orientation = angle of evec1 w.r.t. global X-axis if axis1 is major.
				if (axis1 >= axis2)
				{
					a = axis1;  // major
					b = axis2;  // minor

					// Orientation = angle of evec1 (the larger axis) in the XY-plane
					double ang = std::atan2(evec1(1), evec1(0));
					// keep angle in [0, 2Ï€) if desired
					if (ang < 0) ang += 2.0 * M_PI;
					orientation = ang;
				}
				else
				{
					a = axis2;  // major
					b = axis1;  // minor

					// orientation = angle of evec2
					double ang = std::atan2(evec2(1), evec2(0));
					if (ang < 0) ang += 2.0 * M_PI;
					orientation = ang;
				}

				return true;
			}

			OLGA_INLINE bool EllipseP2N2C1BasedSolver::getConicCenter(double A, double B, double C, double D, double E,
                           double &xc, double &yc) const
			{
				// Solve:
				//  [2A   B ] [xc] = [-D]
				//  [ B  2C ] [yc]   [-E]
				double det = 4.0 * A * C - B * B;
				if (std::fabs(det) < 1e-14)
					return false; // Degenerate or no unique center

				xc = ( -D*2.0*C - (-E)*B ) / (2.0 * C * 2.0 * A - B * B);
				yc = ( (-E)*2.0*A - (-D)*B ) / (2.0 * A * 2.0 * C - B * B);

				return true;
			}

			OLGA_INLINE bool EllipseP2N2C1BasedSolver::normalizePoints(
				const cv::Mat& data_, // The set of data points
				cv::Mat& normalized_data_,
				double &x_mean_,
				double &y_mean_,
				double &x_stddev_,
				double &y_stddev_,
				const size_t *sample_, // The sample used for the estimation
				size_t sample_number_) const // The size of the sample
			{
				// The number of columns in the data matrix
				const size_t columns = data_.cols;
				// The pointer to the data matrix
				const double* data_ptr = reinterpret_cast<const double*>(data_.data);

				// Calculate the mean x and y
				x_mean_ = 0.0;
				y_mean_ = 0.0;
				for (size_t i = 0; i < sample_number_; ++i) {
					const size_t idx = (sample_ == nullptr) ? i : sample_[i];
					const double* point_ptr = data_ptr + idx * columns;
					x_mean_ += point_ptr[0];
					y_mean_ += point_ptr[1];
				}
				x_mean_ /= sample_number_;
				y_mean_ /= sample_number_;

				// Calculate the standard deviation of x and y
				x_stddev_ = 0.0;
				y_stddev_ = 0.0;
				for (size_t i = 0; i < sample_number_; ++i) {
					const size_t idx = (sample_ == nullptr) ? i : sample_[i];
					const double* point_ptr = data_ptr + idx * columns;
					double x = point_ptr[0] - x_mean_;  // Center first
					double y = point_ptr[1] - y_mean_;  // Center first
					x_stddev_ += x * x;
					y_stddev_ += y * y;
				}
				x_stddev_ = std::sqrt(x_stddev_ / sample_number_);
				y_stddev_ = std::sqrt(y_stddev_ / sample_number_);

				if (x_stddev_ < 1e-8 || y_stddev_ < 1e-8) { // Prevent division by zero
					return false;
				}

				normalized_data_.create(sample_number_, columns, CV_64F);
				double* normalized_data_ptr = reinterpret_cast<double*>(normalized_data_.data);

				// Normalize the points
				for (size_t i = 0; i < sample_number_; ++i) {
					const size_t idx = (sample_ == nullptr) ? i : sample_[i];
					const double* point_ptr = data_ptr + idx * columns;
					normalized_data_ptr[i * columns] = (point_ptr[0] - x_mean_) / x_stddev_ ;
					normalized_data_ptr[i * columns + 1] = (point_ptr[1] - y_mean_) / y_stddev_;

					for (size_t j = 2; j < columns; ++j)
						normalized_data_ptr[i * columns + j] = point_ptr[j];
				}

				return true;
			}
					
			Eigen::MatrixXcd EllipseP2N2C1BasedSolver::solver_ellipse_2PGC(const Eigen::VectorXd& data) const
			{
				// Compute coefficients
				const double* d = data.data();
				Eigen::VectorXd coeffs(47);
				coeffs[0] = std::pow(d[1],2);
				coeffs[1] = -2*d[1];
				coeffs[2] = 1;
				coeffs[3] = std::pow(d[0],2);
				coeffs[4] = 2*d[0];
				coeffs[5] = -2*d[0]*d[1];
				coeffs[6] = 2*d[0]*d[1];
				coeffs[7] = 2*d[1];
				coeffs[8] = -1;
				coeffs[9] = -d[1]*d[2];
				coeffs[10] = d[2];
				coeffs[11] = d[0]*d[3];
				coeffs[12] = d[3];
				coeffs[13] = d[0]*d[2] - d[1]*d[3];
				coeffs[14] = -d[0]*d[2] + d[1]*d[3];
				coeffs[15] = -d[2];
				coeffs[16] = std::pow(d[0],2)*d[1];
				coeffs[17] = -std::pow(d[0],2);
				coeffs[18] = -2*d[0];
				coeffs[19] = d[1];
				coeffs[20] = -std::pow(d[0],3) + 2*d[0]*std::pow(d[1],2);
				coeffs[21] = -2*std::pow(d[0],2) + 2*std::pow(d[1],2);
				coeffs[22] = -d[0];
				coeffs[23] = -std::pow(d[0],2)*d[1] + std::pow(d[1],3);
				coeffs[24] = -std::pow(d[0],2) - std::pow(d[1],2);
				coeffs[25] = -std::pow(d[2],2)*d[3]*d[4];
				coeffs[26] = -std::pow(d[0],3) + d[0]*std::pow(d[1],2);
				coeffs[27] = std::pow(d[2],3)*d[4] - 2*d[2]*std::pow(d[3],2)*d[4];
				coeffs[28] = -2*std::pow(d[0],2)*d[1] + std::pow(d[1],3);
				coeffs[29] = -std::pow(d[1],2);
				coeffs[30] = 2*std::pow(d[2],2)*d[3]*d[4] - std::pow(d[3],3)*d[4];
				coeffs[31] = -d[0]*std::pow(d[1],2);
				coeffs[32] = d[2]*std::pow(d[3],2)*d[4];
				coeffs[33] = std::pow(d[6],2);
				coeffs[34] = -2*d[6];
				coeffs[35] = std::pow(d[5],2);
				coeffs[36] = 2*d[5];
				coeffs[37] = -2*d[5]*d[6];
				coeffs[38] = 2*d[5]*d[6];
				coeffs[39] = 2*d[6];
				coeffs[40] = -d[6]*d[7];
				coeffs[41] = d[7];
				coeffs[42] = d[5]*d[8];
				coeffs[43] = d[8];
				coeffs[44] = d[5]*d[7] - d[6]*d[8];
				coeffs[45] = -d[5]*d[7] + d[6]*d[8];
				coeffs[46] = -d[7];

				// Setup elimination template
				static const int coeffs0_ind[] = { 0,9,16,1,0,9,33,10,17,40,2,1,10,34,41,2,2,0,9,16,1,0,10,9,33,17,6,2,1,0,9,33,10,34,40,18,2,1,10,34,2,41,2,2,0,9,33,6,40,1,0,9,33,10,34,40,18,19,41,2,1,10,34,2,41,8,2,2,0,9,33,40,19,1,10,34,41,8,2,2,3,11,16,3,11,35,17,42,3,11,16,4,3,12,6,11,17,35,4,12,36,3,11,35,18,42,43,4,3,12,6,11,35,42,2,4,3,11,35,19,12,18,36,42,2,2,4,12,36,8,43,2,4,3,11,35,19,12,36,42,43,2,4,12,36,8,2,43,2,4,12,36,2,43,0,9,33,1,0,10,9,33,34,40,2,1,0,9,33,10,34,2,40,41,2,1,10,34,2,41,2,2,0,9,33,40,1,0,10,9,33,34,40,41,2,1,0,9,33,10,34,2,40,41,2,1,10,34,2,41,2,2,0,9,33,40,1,0,9,33,10,34,40,41,2,1,10,34,2,41,2,2,9,0,10,9,1,9,33,0,40,10,9,0,33,34,1,40,41,10,1,34,2,2,41,2,2,3,11,16,35,3,11,16,17,35,42,3,11,35,17,42,4,3,12,11,16,35,6,36,42,4,3,12,6,11,17,35,18,36,42,43,4,12,36,3,11,35,18,42,43,2,4,3,12,6,11,35,36,19,2,42,43,2,4,3,11,35,19,12,18,36,42,8,2,43,2,2,4,12,36,8,43,2,4,19,12,36,2,43,2,4,12,36,8,2,43,2,2,9,16,0,5,13,10,9,17,0,20,33,1,40,4,5,13,37,12,10,0,9,33,1,5,34,40,2,41,44,4,12,36,1,10,34,2,2,41,43,2,2,5,13,9,6,0,20,33,40,4,5,12,13,37,11,10,9,3,18,1,5,0,33,21,34,40,41,4,5,13,37,12,36,44,11,10,9,33,2,1,0,34,1,2,40,41,4,12,36,43,10,34,2,1,2,41,2,2,5,13,37,11,9,35,19,21,0,33,3,40,42,44,4,5,13,37,12,36,44,12,11,3,35,4,10,9,0,33,8,1,1,34,40,22,42,41,43,4,12,36,43,12,10,1,34,2,2,41,2,2,5,13,37,44,12,9,0,33,36,22,40,4,43,4,12,36,43,12,4,36,2,10,1,34,41,43,2,2,2,2,11,16,3,6,14,20,11,17,3,35,42,6,14,38,5,3,11,35,42,45,6,14,20,12,11,6,3,35,4,42,7,6,15,21,14,5,38,12,11,18,4,3,35,36,42,43,7,15,39,6,14,38,1,45,4,12,36,11,35,3,42,43,46,7,6,15,21,14,38,12,11,19,4,3,35,36,42,2,43,45,7,6,14,38,22,15,1,39,45,12,11,3,35,8,2,4,36,42,2,43,7,15,39,46,2,2,12,36,4,43,7,6,14,38,22,15,39,45,12,11,3,35,2,4,36,42,2,43,46,7,15,39,46,12,4,36,2,2,43,7,15,39,46,12,4,36,2,2,43,5,13,9,33,37,0,40,4,5,12,13,10,9,0,33,34,37,36,1,40,41,44,4,5,13,37,12,10,0,9,33,1,34,2,36,2,40,41,44,43,4,12,36,1,10,34,2,2,41,43,2,2,5,13,37,9,0,33,40,44,4,5,12,13,37,36,10,9,33,1,0,34,40,41,44,43,4,5,13,37,12,36,44,10,0,33,34,2,9,1,2,40,41,43,4,12,36,43,1,34,2,10,2,41,2,2,5,13,37,9,33,0,40,44,4,5,13,37,12,36,44,10,9,0,33,34,1,40,41,43,4,12,36,43,10,1,34,2,2,41,2,2,0,9,1,10,9,9,33,0,40,13,5,10,9,33,34,0,40,1,41,12,13,4,10,34,2,1,41,2,12,2,2,13,37,33,9,0,5,40,44,12,13,5,37,36,34,10,1,4,41,44,43,12,4,36,2,2,43,6,14,11,20,16,35,38,3,42,6,14,20,11,5,17,3,35,38,42,45,6,14,38,5,3,11,35,42,45,7,6,15,14,20,38,12,11,21,6,3,35,36,39,4,42,43,45,7,6,15,21,14,5,38,12,11,1,18,4,35,3,36,39,42,43,45,46,7,15,39,6,14,38,1,45,4,12,36,3,35,11,42,43,46,7,6,15,21,14,38,39,12,22,11,19,4,35,36,3,2,42,45,2,43,46,7,6,14,38,22,15,1,39,45,12,11,3,35,8,2,36,4,2,42,43,46,7,15,39,46,2,2,4,36,12,43,7,22,15,39,12,2,36,2,4,43,46,7,15,39,46,12,4,36,2,2,43,2,2,13,20,9,0,33,5,40,3,11,12,13,5,5,3,11,10,9,23,0,1,33,34,37,40,4,41,44,3,11,35,12,5,13,37,4,10,0,24,33,1,2,9,34,2,36,11,40,41,44,43,42,4,12,36,1,34,2,10,2,41,43,2,2,3,11,13,21,5,23,11,35,33,9,0,37,3,40,42,44,3,11,35,14,12,13,6,1,4,24,5,37,4,12,11,35,9,33,0,34,3,10,1,36,40,42,41,44,43,3,11,35,42,14,12,13,37,4,5,36,18,10,34,1,2,2,41,12,44,43,12,36,4,2,2,43,3,11,35,14,13,38,22,5,37,12,36,35,11,3,9,33,0,6,40,42,4,44,43,45,42,3,11,35,42,15,14,6,38,7,12,13,5,37,18,4,36,44,2,12,36,19,10,34,1,4,41,45,43,43,15,12,4,36,43,8,2,2,3,11,35,42,15,13,5,37,39,19,44,2,36,12,4,7,43,2,46,15,7,39,12,4,36,8,43,2,2,46,2,2,14,20,11,3,35,6,42,0,9,23,14,5,6,11,3,35,38,42,45,0,9,33,24,6,14,38,3,35,11,42,45,40,0,9,23,15,14,21,6,12,35,4,11,3,36,38,42,7,43,45,0,9,24,33,15,14,1,7,6,38,12,4,11,35,3,36,39,42,43,45,46,0,9,33,18,40,7,15,39,14,38,6,4,36,12,43,45,46,0,9,33,15,14,22,7,6,38,11,35,3,36,2,12,4,2,39,42,43,45,46,40,0,9,33,19,18,40,15,14,6,38,7,39,45,2,12,36,4,2,43,46,8,15,39,7,2,2,46,0,9,33,19,40,15,14,6,38,7,39,45,12,36,4,2,2,43,46,3,11,13,9,33,37,35,0,5,40,44,3,11,12,13,5,37,25,10,9,0,33,34,36,35,1,4,40,44,41,43,42,3,11,35,12,5,13,37,4,36,10,1,33,34,2,0,9,2,40,41,44,43,42,4,12,36,2,34,2,1,10,41,43,2,2,3,11,35,25,13,5,37,9,33,40,44,0,42,3,11,35,12,13,37,4,5,36,10,9,0,34,33,40,41,44,43,1,42,3,11,35,42,12,5,37,36,13,4,44,10,1,2,34,41,43,2,4,36,12,43,2,2,3,11,35,13,37,5,9,0,33,40,44,42,3,11,35,42,12,13,5,37,36,4,44,10,1,34,41,43,12,4,36,43,2,2,33,9,40,0,5,13,34,33,9,0,10,40,41,1,4,12,2,34,10,1,13,41,2,2,2,12,13,37,9,33,0,40,5,44,11,3,12,13,37,36,5,10,34,1,44,41,4,43,11,12,36,4,2,2,43,11,35,37,13,5,3,44,42,11,3,35,36,12,4,43,42,0,9,14,23,20,11,35,38,33,3,6,42,45,8,25,0,9,23,14,24,5,6,38,11,3,35,33,42,45,40,8,8,0,9,33,24,6,14,38,35,3,11,42,45,40,8,25,0,9,23,33,15,14,21,6,38,12,11,35,36,39,4,42,7,45,3,43,46,40,8,8,0,9,24,33,15,14,18,1,7,38,6,39,12,4,36,11,3,35,42,45,43,46,40,8,8,0,9,33,18,40,7,15,39,6,38,14,45,36,4,12,43,46,8,8,0,9,33,15,19,14,22,7,38,39,6,12,36,11,3,35,2,42,2,45,40,43,46,4,8,8,0,9,33,19,18,40,15,8,14,6,38,39,7,45,2,2,12,4,36,43,46,8,7,39,15,46,2,2,8,8,19,15,39,7,2,12,4,36,43,46,2,11,23,13,5,37,35,9,11,33,40,42,0,3,3,44,11,24,3,6,14,12,13,26,5,4,37,36,35,35,11,3,10,9,33,0,34,40,42,41,1,44,43,42,3,11,35,12,5,5,37,4,13,36,10,34,14,1,2,41,44,2,43,42,4,36,12,2,2,43,11,3,26,14,38,37,13,5,35,36,11,35,3,33,9,12,40,42,6,0,44,43,45,4,42,9,11,0,18,5,3,35,7,15,14,38,21,13,37,5,36,6,12,4,36,12,4,44,34,10,41,45,43,1,43,42,9,11,35,3,1,12,36,4,43,15,2,2,42,9,11,33,19,21,3,35,15,39,38,14,6,13,37,5,0,44,45,2,12,36,4,43,7,42,46,40,2,9,0,33,11,3,35,8,1,42,15,39,22,12,36,4,7,43,2,2,40,46,11,3,35,22,42,39,15,7,46,2,2,9,23,14,6,38,11,35,42,3,0,45,26,9,24,0,14,6,38,33,11,35,3,42,45,40,5,0,9,33,6,38,14,45,40,26,9,0,15,38,7,14,6,39,33,12,35,11,42,36,3,43,45,4,46,40,21,5,9,18,0,33,15,7,14,38,6,39,45,12,36,4,43,46,40,1,9,33,0,7,39,15,46,40,21,9,19,0,33,14,38,6,39,15,7,45,36,12,43,2,4,46,40,2,8,25,8,8,25,8,8,25,8,8,8,25,11,13,37,35,5,33,0,9,40,3,44,42,11,3,35,27,12,13,5,37,36,4,34,0,40,9,1,10,33,41,44,42,43,3,11,35,12,4,37,36,5,13,44,2,1,41,10,2,34,43,42,36,4,12,43,2,2,27,11,3,35,13,37,40,9,33,44,0,42,5,8,11,35,3,12,13,5,36,37,44,41,10,34,43,42,1,4,3,35,11,42,12,4,36,43,2,2,8,11,35,3,8,13,5,37,44,42,8,8,11,3,35,42,12,4,36,43,37,13,33,40,0,44,9,5,3,11,36,37,13,5,12,44,34,41,1,43,10,4,36,12,4,11,43,2,2,11,35,13,37,5,44,3,42,11,35,3,12,36,4,42,43,25,9,26,23,14,38,33,6,35,3,11,42,0,8,45,40,27,26,8,9,5,24,0,33,8,14,6,38,3,42,11,35,45,40,5,8,8,0,9,33,38,6,14,45,40,27,26,8,9,21,0,33,8,15,14,38,39,7,36,42,11,35,45,4,12,43,3,40,6,46,21,5,8,8,9,1,18,33,0,15,7,39,14,6,38,45,4,43,12,40,36,46,1,8,8,0,33,9,40,39,7,15,46,21,8,8,22,9,19,33,0,15,39,14,6,38,45,40,2,43,12,36,46,2,4,7,26,11,3,35,38,13,14,37,35,42,3,44,33,45,11,0,5,9,6,42,40,5,0,9,11,28,3,35,38,14,6,12,13,37,5,36,44,45,43,34,1,4,42,10,41,3,29,35,11,12,36,9,4,43,42,2,2,21,28,9,33,35,11,3,39,14,38,6,37,13,15,44,45,0,5,36,43,4,42,46,12,40,7,1,29,9,33,5,11,35,3,0,39,15,7,42,36,12,43,40,46,4,22,5,33,9,0,11,35,3,42,40,15,39,7,46,2,2,26,9,0,33,14,38,45,35,3,6,11,40,42,28,5,9,0,33,14,38,6,45,40,28,21,33,9,0,15,38,14,45,39,6,46,40,36,4,7,12,43,27,25,8,8,27,8,8,27,8,8,27,11,35,3,37,5,13,44,33,40,42,9,0,8,30,11,3,35,36,5,44,13,4,12,37,43,42,34,41,10,1,35,3,11,42,4,43,12,36,2,2,30,8,11,35,8,44,13,37,42,5,3,8,8,11,3,35,42,43,12,36,4,35,11,37,44,5,42,13,3,35,11,3,42,36,43,4,12,27,28,26,8,8,9,33,0,38,6,14,45,35,42,40,11,3,30,28,29,5,8,8,9,0,33,6,45,14,38,40,30,28,5,21,8,8,9,33,39,45,14,38,40,7,15,46,6,36,43,0,12,4,28,33,11,9,35,38,45,6,42,37,40,14,5,3,13,0,44,5,31,9,33,0,35,11,42,40,3,39,46,7,15,30,27,8,8,32,8,8,3,42,11,35,36,43,12,4,32,8,8,42,11,35,3,32,31,29,8,8,0,40,9,33,32,31,5,8,8,40,9,33,0,39,46,15,7,32,30,8,8,30,8,8,30,8,8,30,8,35,3,11,42,37,44,8,13,5,30,31,28,8,33,0,9,40,8,38,45,14,6 };
				static const int coeffs1_ind[] = { 32,8,8,32,8,8,32,8,8,32,8,8,35,42,11,3,32,31,8,8,33,40,9,0 };

				static const int C0_ind[] = { 0,16,127,256,257,258,259,272,383,508,512,513,514,515,764,769,771,1028,1042,1105,1284,1285,1298,1299,1303,1361,1407,1540,1541,1542,1543,1544,1555,1559,1562,1663,1797,1798,1799,1800,1815,1818,2054,2056,2313,2325,2326,2385,2550,2569,2570,2571,2572,2581,2582,2585,2641,2687,2806,2825,2826,2827,2828,2838,2841,2943,3082,3084,3341,3342,3343,3352,3409,3597,3598,3599,3608,3665,3853,3855,4096,4112,4113,4353,4354,4355,4369,4604,4612,4626,4628,4864,4869,4880,4881,4883,4884,4887,5121,5122,5123,5126,5127,5128,5137,5146,5372,5380,5385,5394,5396,5397,5398,5622,5632,5637,5642,5643,5644,5649,5651,5652,5655,5657,5889,5891,5894,5895,5896,5905,5914,6148,6153,6157,6158,6159,6164,6165,6166,6168,6390,6405,6410,6411,6412,6420,6423,6425,6665,6669,6670,6671,6678,6680,6939,6959,7088,7195,7196,7215,7216,7343,7344,7423,7451,7452,7453,7454,7455,7472,7599,7600,7675,7679,7708,7709,7710,7711,7855,7931,7965,7967,8224,8242,8248,8446,8480,8481,8498,8499,8503,8504,8697,8702,8736,8737,8738,8739,8740,8755,8759,8760,8762,8953,8993,8994,8995,8996,9015,9018,9250,9252,9509,9525,9526,9672,9765,9766,9767,9768,9781,9782,9785,9928,10021,10022,10023,10024,10038,10041,10278,10280,10537,10563,10793,10794,10819,11051,11084,11146,11235,11307,11308,11309,11310,11340,11402,11433,11491,11564,11565,11566,11596,11658,11689,11821,11822,12059,12079,12129,12208,12316,12336,12337,12385,12463,12543,12573,12574,12575,12593,12795,12827,12832,12847,12850,12852,12856,12897,12976,13054,13084,13089,13104,13105,13107,13108,13111,13153,13231,13305,13311,13341,13342,13343,13346,13347,13348,13361,13370,13563,13595,13600,13605,13618,13620,13621,13622,13624,13665,13744,13768,13822,13852,13857,13862,13863,13864,13873,13875,13876,13879,13881,13921,13999,14073,14109,14111,14114,14115,14116,14129,14138,14368,14373,14388,14389,14390,14392,14536,14625,14630,14631,14632,14644,14647,14649,14885,14902,15163,15182,15344,15360,15376,15419,15420,15438,15439,15487,15506,15600,15608,15616,15617,15618,15619,15632,15676,15677,15678,15679,15695,15743,15762,15854,15856,15864,15868,15873,15874,15875,15933,15934,15935,15951,16018,16110,16124,16189,16191,16388,16402,16448,16462,16464,16465,16529,16629,16644,16645,16658,16659,16663,16681,16704,16705,16707,16718,16720,16721,16722,16726,16767,16785,16875,16885,16901,16902,16903,16904,16915,16919,16922,16938,16961,16962,16964,16976,16978,16981,16982,17023,17041,17094,17131,17158,17159,17160,17178,17218,17220,17234,17237,17238,17350,17476,17493,17673,17685,17686,17707,17733,17740,17742,17745,17747,17748,17802,17881,17891,17910,17929,17930,17931,17932,17941,17942,17945,17961,17964,17965,17966,17987,17989,17990,17991,17992,17998,18001,18003,18004,18008,18047,18089,18137,18166,18186,18187,18188,18201,18218,18246,18247,18248,18259,18260,18264,18503,18504,18701,18702,18703,18712,18731,18761,18762,18763,18764,18769,18775,18826,18915,18957,18958,18959,18968,18988,18989,18990,19011,19017,19018,19019,19031,19113,19274,19275,19532,19594,19771,19789,19952,19968,19984,19985,20028,20045,20047,20114,20216,20225,20226,20227,20241,20285,20286,20287,20462,20476,20484,20498,20500,20539,20544,20557,20560,20625,20720,20725,20736,20741,20752,20753,20755,20756,20759,20796,20801,20813,20815,20818,20822,20882,20971,20984,20993,20994,20995,20998,20999,21000,21009,21018,21053,21054,21055,21058,21060,21077,21190,21230,21244,21252,21257,21266,21268,21269,21270,21312,21317,21325,21328,21331,21332,21393,21465,21488,21493,21494,21509,21514,21515,21516,21521,21523,21524,21527,21529,21569,21574,21575,21576,21581,21583,21586,21590,21592,21650,21739,21766,21767,21768,21786,21821,21823,21826,21828,21845,21958,22025,22029,22030,22031,22036,22037,22038,22040,22085,22089,22090,22091,22096,22099,22100,22103,22161,22233,22262,22282,22283,22284,22297,22342,22343,22344,22354,22358,22360,22541,22542,22543,22552,22601,22602,22603,22611,22612,22615,22811,22831,22873,22958,22960,23004,23037,23067,23068,23087,23088,23129,23130,23153,23160,23214,23215,23216,23260,23273,23293,23295,23324,23325,23326,23327,23344,23386,23387,23388,23389,23409,23416,23470,23471,23516,23527,23529,23547,23551,23581,23582,23583,23643,23644,23645,23665,23672,23783,23803,23899,23901,24096,24114,24120,24158,24179,24183,24296,24318,24352,24353,24370,24371,24375,24376,24414,24415,24434,24435,24437,24439,24529,24552,24569,24574,24609,24610,24611,24612,24627,24631,24634,24671,24672,24674,24690,24691,24692,24693,24695,24699,24785,24825,24866,24867,24868,24890,24928,24930,24946,24948,24949,24955,25184,25186,25381,25397,25398,25443,25462,25465,25543,25544,25637,25638,25639,25640,25653,25654,25657,25699,25700,25701,25702,25718,25721,25722,25799,25800,25894,25895,25896,25913,25956,25957,25958,25974,25977,25978,26213,26214,26471,26472,26727,26728,26807,26985,26988,27072,27105,27177,27203,27241,27242,27243,27244,27273,27325,27328,27361,27433,27434,27459,27498,27499,27500,27529,27581,27584,27690,27755,27785,27947,27980,28013,28014,28015,28042,28052,28131,28203,28204,28205,28206,28236,28269,28270,28271,28298,28308,28329,28387,28460,28461,28462,28525,28527,28585,28699,28719,28761,28769,28784,28846,28848,28892,28925,28956,28976,28977,29018,29025,29040,29041,29048,29103,29161,29183,29213,29214,29215,29233,29275,29276,29277,29415,29435,29467,29472,29487,29490,29492,29496,29529,29534,29537,29552,29555,29559,29614,29616,29660,29672,29693,29694,29724,29729,29744,29745,29747,29748,29751,29786,29791,29793,29808,29809,29810,29813,29816,29871,29905,29929,29945,29951,29981,29982,29983,29986,29987,29988,30001,30010,30043,30044,30045,30048,30050,30068,30075,30183,30203,30240,30245,30258,30260,30261,30262,30264,30302,30305,30307,30320,30323,30326,30327,30329,30382,30407,30408,30428,30440,30462,30497,30502,30503,30504,30513,30515,30516,30519,30521,30559,30564,30565,30566,30576,30577,30578,30581,30584,30586,30673,30713,30754,30755,30756,30778,30811,30813,30816,30818,30836,30843,31013,31028,31029,31030,31075,31091,31094,31095,31097,31175,31176,31270,31271,31272,31289,31332,31333,31334,31346,31349,31354,31606,31609,31803,31822,31868,31883,31888,31984,31987,32000,32016,32059,32060,32078,32079,32103,32104,32124,32125,32127,32129,32139,32141,32144,32146,32230,32240,32243,32248,32257,32258,32259,32316,32317,32318,32319,32335,32381,32382,32383,32384,32385,32395,32396,32397,32400,32402,32439,32451,32486,32494,32504,32508,32573,32574,32575,32638,32640,32641,32652,32653,32707,32750,32894,32896,33028,33042,33088,33102,33104,33105,33129,33132,33160,33166,33167,33169,33216,33238,33249,33269,33285,33299,33303,33321,33344,33345,33347,33358,33360,33361,33362,33366,33383,33384,33386,33387,33410,33411,33412,33416,33417,33422,33423,33425,33448,33469,33494,33515,33525,33542,33543,33544,33562,33578,33601,33602,33604,33618,33621,33622,33663,33666,33667,33668,33672,33679,33704,33719,33734,33771,33858,33860,33877,33923,33924,33990,34057,34069,34070,34091,34117,34124,34126,34131,34132,34153,34156,34157,34158,34159,34181,34182,34183,34186,34195,34196,34240,34265,34273,34275,34294,34314,34315,34316,34329,34345,34348,34349,34350,34371,34373,34374,34375,34376,34385,34387,34388,34392,34407,34410,34411,34431,34437,34438,34439,34441,34451,34473,34493,34521,34602,34630,34631,34632,34648,34687,34694,34695,34829,34830,34831,34840,34859,34889,34890,34891,34892,34897,34903,34924,34925,34926,34927,34954,34964,35008,35043,35116,35117,35118,35145,35146,35147,35153,35159,35179,35209,35241,35437,35439,35643,35661,35708,35723,35728,35824,35827,35840,35856,35857,35900,35917,35919,35965,35969,35981,35986,36070,36088,36097,36098,36099,36113,36157,36158,36159,36222,36224,36236,36291,36334,36348,36356,36370,36372,36411,36416,36429,36432,36476,36488,36491,36494,36495,36496,36497,36566,36592,36595,36597,36613,36627,36628,36631,36668,36673,36685,36687,36690,36694,36733,36737,36738,36739,36740,36749,36754,36776,36838,36843,36856,36870,36871,36872,36881,36890,36925,36926,36927,36930,36932,36949,36990,36992,37004,37059,37062,37102,37129,37141,37142,37184,37189,37197,37200,37203,37204,37253,37254,37255,37256,37259,37262,37263,37264,37265,37267,37334,37337,37365,37366,37386,37387,37388,37393,37396,37401,37441,37446,37447,37448,37458,37462,37464,37505,37506,37507,37508,37517,37544,37611,37649,37698,37700,37717,37758,37760,37830,37901,37902,37903,37908,37912,37957,37961,37962,37963,37971,37972,37975,38021,38022,38023,38024,38031,38035,38105,38171,38191,38233,38293,38314,38318,38320,38322,38364,38386,38397,38428,38448,38489,38490,38513,38520,38527,38549,38550,38551,38553,38570,38574,38575,38578,38620,38629,38633,38642,38653,38655,38685,38686,38687,38746,38747,38748,38749,38769,38776,38806,38807,38808,38809,38826,38827,38828,38834,38853,38885,38887,38889,38907,39003,39004,39005,39063,39064,39065,39083,39084,39109,39143,39320,39339,39456,39474,39480,39505,39518,39539,39543,39578,39581,39632,39656,39665,39678,39713,39731,39735,39774,39775,39794,39795,39797,39799,39834,39835,39836,39837,39853,39859,39888,39889,39912,39921,39929,39970,39971,39972,39994,40031,40032,40034,40050,40052,40053,40059,40091,40092,40093,40109,40115,40145,40177,40288,40290,40308,40315,40348,40365,40485,40501,40502,40547,40566,40569,40606,40607,40608,40625,40647,40648,40742,40743,40744,40761,40803,40804,40805,40806,40822,40825,40826,40862,40863,40864,40881,40903,41060,41061,41062,41082,41119,41120,41377,41402,41439,41455,41575,41576,41633,41634,41635,41636,41658,41666,41695,41711,41831,41832,41889,41890,41891,41892,41911,41922,41967,42146,42148,42167,42345,42348,42405,42406,42407,42430,42432,42465,42537,42563,42601,42602,42603,42604,42633,42661,42662,42663,42685,42686,42688,42721,42794,42858,42859,42889,42918,42919,42941,43051,43084,43117,43118,43119,43146,43156,43235,43308,43309,43310,43373,43374,43375,43412,43433,43547,43567,43609,43617,43632,43669,43690,43694,43696,43698,43740,43762,43773,43776,43793,43804,43824,43825,43866,43873,43888,43889,43896,43926,43927,43929,43951,44005,44009,44031,44033,44035,44061,44062,44063,44081,44123,44124,44125,44184,44203,44204,44229,44263,44283,44292,44308,44320,44338,44340,44344,44377,44382,44400,44403,44407,44437,44442,44445,44458,44462,44466,44496,44508,44520,44529,44530,44541,44542,44549,44567,44577,44595,44596,44599,44634,44639,44641,44656,44657,44658,44661,44664,44694,44695,44697,44699,44700,44717,44723,44753,44773,44777,44793,44806,44808,44834,44835,44836,44849,44858,44891,44892,44893,44896,44898,44916,44923,44952,44971,44972,44997,45031,45065,45078,45093,45109,45110,45150,45153,45155,45168,45171,45174,45175,45177,45210,45213,45214,45215,45216,45226,45233,45234,45255,45256,45264,45288,45297,45322,45324,45350,45351,45352,45361,45364,45369,45407,45409,45412,45413,45414,45426,45429,45434,45463,45465,45467,45468,45485,45491,45521,45617,45664,45666,45684,45691,45720,45739,45837,45839,45876,45923,45942,45945,45981,45982,45983,45984,46001,46023,46065,46139,46158,46204,46219,46224,46241,46260,46266,46271,46293,46303,46308,46319,46320,46323,46396,46414,46415,46439,46440,46460,46461,46463,46465,46475,46477,46480,46482,46498,46499,46500,46516,46517,46518,46523,46527,46529,46530,46549,46564,46566,46579,46584,46653,46654,46655,46717,46718,46719,46720,46721,46732,46733,46773,46774,46775,46779,46783,46785,46787,46820,46822,46830,46974,46976,46988,47030,47035,47043,47168,47184,47185,47209,47212,47240,47246,47247,47249,47265,47269,47270,47271,47288,47289,47290,47292,47294,47296,47300,47318,47327,47329,47343,47349,47401,47425,47427,47438,47441,47442,47446,47463,47464,47466,47467,47487,47490,47491,47492,47496,47497,47502,47503,47522,47523,47524,47528,47544,47545,47548,47549,47554,47556,47574,47595,47658,47682,47684,47701,47743,47746,47747,47748,47784,47799,47800,47812,47814,47915,47941,47948,47950,47953,47955,47956,47977,47980,47981,47982,47983,48005,48006,48007,48010,48019,48020,48033,48037,48038,48039,48062,48064,48089,48097,48099,48111,48172,48173,48174,48198,48199,48200,48206,48209,48216,48234,48235,48255,48261,48262,48263,48265,48275,48290,48292,48297,48317,48457,48458,48459,48465,48471,48493,48494,48495,48532,48550,48551,48699,48717,48764,48779,48784,48820,48831,48853,48868,48880,48883,48913,48956,48973,48975,49021,49025,49037,49042,49077,49078,49083,49089,49126,49144,49169,49213,49214,49215,49278,49280,49292,49347,49390,49428,49472,49488,49532,49544,49547,49550,49551,49552,49553,49588,49592,49593,49596,49599,49604,49621,49622,49636,49651,49653,49681,49684,49729,49741,49746,49750,49789,49793,49794,49795,49796,49805,49832,49845,49846,49851,49857,49894,49899,49937,49986,49988,50005,50046,50048,50060,50115,50118,50196,50245,50253,50259,50260,50309,50310,50311,50312,50318,50319,50323,50360,50361,50364,50367,50372,50390,50393,50404,50459,50529,50608,50716,50737,50863,50976,50996,51000,51233,51255,51534,51545,51605,51626,51630,51634,51657,51671,51672,51675,51676,51698,51709,51802,51825,51832,51839,51861,51862,51863,51865,51882,51890,51913,51914,51915,51916,51927,51928,51930,51931,51941,51945,51954,52059,52060,52061,52118,52119,52120,52121,52139,52140,52165,52169,52170,52171,52172,52183,52186,52197,52199,52376,52395,52396,52421,52426,52442,52561,52574,52595,52599,52634,52637,52685,52686,52687,52688,52701,52712,52721,52803,52831,52850,52853,52890,52891,52892,52893,52909,52915,52941,52942,52943,52944,52945,52957,52977,53088,53090,53108,53115,53147,53148,53165,53171,53199,53213,53324,53347,53366,53369,53386,53406,53407,53408,53425,53447,53549,53550,53604,53605,53606,53626,53662,53663,53664,53681,53921,53946,53970,53971,53972,53983,53984,53999,54119,54120,54177,54178,54179,54180,54202,54210,54226,54227,54228,54239,54240,54255,54434,54435,54436,54455,54466,54482,54484,54633,54636,54693,54694,54695,54718,54720,54753,54890,54891,54921,54949,54950,54951,54973,54974,55117,55129,55137,55152,55189,55210,55214,55218,55241,55255,55256,55259,55260,55280,55282,55293,55313,55345,55375,55386,55393,55408,55409,55416,55442,55446,55447,55449,55498,55499,55500,55514,55525,55529,55601,55613,55615,55643,55644,55645,55704,55723,55724,55749,55783,55828,55860,55888,55902,55905,55923,55927,55953,55957,55962,55965,55978,55986,56009,56013,56014,56015,56016,56023,56024,56027,56029,56040,56049,56050,56113,56116,56146,56150,56159,56161,56176,56178,56181,56214,56215,56217,56219,56220,56237,56243,56266,56267,56268,56273,56282,56293,56369,56388,56405,56416,56418,56436,56443,56472,56491,56492,56517,56628,56659,56660,56673,56675,56688,56694,56697,56730,56733,56734,56735,56736,56753,56775,56777,56781,56782,56783,56784,56791,56797,56817,56910,56956,56971,56976,56993,57012,57018,57023,57042,57043,57044,57045,57054,57055,57056,57058,57060,57068,57071,57075,57079,57166,57191,57192,57213,57215,57217,57229,57250,57251,57252,57268,57269,57270,57275,57279,57281,57282,57301,57310,57314,57316,57318,57324,57335,57470,57471,57472,57484,57525,57526,57527,57531,57537,57539,57566,57570,57678,57681,57705,57708,57736,57742,57743,57761,57765,57766,57767,57784,57785,57786,57788,57790,57792,57796,57810,57811,57812,57814,57823,57824,57825,57839,57934,57937,57962,57963,57983,57986,57987,57988,57993,58018,58019,58020,58024,58040,58041,58044,58045,58050,58052,58190,58193,58221,58222,58223,58245,58246,58247,58259,58260,58277,58278,58279,58302,58322,58324,58445,58492,58507,58512,58548,58559,58581,58590,58594,58596,58604,58611,58615,58641,58701,58749,58753,58765,58805,58806,58811,58817,58854,58900,58957,59016,59022,59023,59060,59064,59065,59068,59071,59076,59093,59094,59102,59106,59108,59116,59127,59233,59248,59310,59356,59441,59505,59512,59700,59763,59767,59982,60053,60074,60082,60105,60119,60120,60123,60138,60141,60146,60148,60154,60263,60287,60310,60311,60313,60361,60362,60363,60364,60375,60376,60378,60379,60389,60394,60397,60404,60410,60568,60587,60588,60613,60618,60619,60620,60634,60650,60666,60753,60780,60826,60829,60864,60877,60878,60879,60880,60893,60913,61035,61065,61083,61084,61101,61107,61133,61134,61135,61149,61345,61370,61394,61395,61396,61407,61408,61423,61602,61603,61604,61634,61650,61651,61652,61664,61773,61793,61808,61835,61840,61845,61866,61874,61897,61911,61912,61915,61930,61933,61938,61940,61946,61969,62001,62049,62064,62081,62093,62102,62103,62105,62154,62155,62156,62170,62181,62228,62260,62305,62320,62344,62351,62362,62365,62409,62413,62414,62415,62416,62423,62424,62427,62429,62442,62445,62449,62452,62458,62542,62625,62644,62650,62655,62674,62675,62676,62677,62686,62687,62688,62690,62692,62700,62703,62711,62798,62801,62885,62886,62887,62904,62905,62908,62910,62916,62930,62931,62932,62944,63073,63088,63146,63154,63359,63394,63396,63434,63435,63436,63450,63466,63469,63476,63482,63569,63654,63655,63693,63694,63695,63709,63761,63793,63856,63926,63931,63946,63947,63948,63962,64020,64052,64112,64184,64196,64205,64206,64207,64221,64234,64237,64244,64250,64353,64368,64457,64471,64561,64663,64665,64820,64925,65009,65102,65185,65225,65239,65240,65243,65258,65261,65263,65268,65274,65357,65377,65392,65471,65481,65495,65496,65499,65508,65514,65517,65524,65530 } ;
				static const int C1_ind[] = { 112,234,250,305,458,474,564,719,733,846,978,980,1002,1005,1012,1018,1101,1136,1246,1250,1258,1261,1268,1274 };

				Eigen::MatrixXd C0 = Eigen::MatrixXd::Zero(256,256);
				Eigen::MatrixXd C1 = Eigen::MatrixXd::Zero(256,5);
				for (int i = 0; i < 2842; i++) { C0(C0_ind[i]) = coeffs(coeffs0_ind[i]); }
				for (int i = 0; i < 24; i++) { C1(C1_ind[i]) = coeffs(coeffs1_ind[i]); } 

				Eigen::MatrixXd C12 = C0.partialPivLu().solve(C1);

				// Setup action matrix
				Eigen::Matrix<double,10, 5> RR;
				RR << -C12.bottomRows(5), Eigen::Matrix<double,5,5>::Identity(5, 5);

				static const int AM_ind[] = { 0,1,2,3,4 };
				Eigen::Matrix<double, 5, 5> AM;
				for (int i = 0; i < 5; i++) {
					AM.row(i) = RR.row(AM_ind[i]);
				}

				Eigen::Matrix<std::complex<double>, 5, 5> sols;
				sols.setZero();

				// Solve eigenvalue problem
				Eigen::EigenSolver<Eigen::Matrix<double, 5, 5> > es(AM);
				Eigen::ArrayXcd D = es.eigenvalues();	
				Eigen::ArrayXXcd V = es.eigenvectors();
				V = (V / V.row(0).array().replicate(5, 1)).eval();

				sols.row(0) = D.transpose().array();
				sols.row(1) = V.row(1).array();
				sols.row(2) = V.row(2).array();
				sols.row(3) = V.row(3).array();
				sols.row(4) = V.row(4).array();

				return sols;
			}
			

			OLGA_INLINE void EllipseP2N2C1BasedSolver::ellipseParamToConic(
				double xc, double yc,
				double a_major, double a_minor,
				double phi,
				// Output: conic parameters
				double &A, double &B, double &C, double &D, double &E, double &F) const
			{
				// We use the geometric form:
				//   ((X - xc)*cos(phi) + (Y - yc)*sin(phi))^2 / a_major^2 +
				//   ((X - xc)*(-sin(phi)) + (Y - yc)*cos(phi))^2 / a_minor^2 = 1
				//
				// Let dx = (X - xc), dy = (Y - yc).
				//
				// Then x' =  dx*cos(phi) + dy*sin(phi)
				//      y' = -dx*sin(phi) + dy*cos(phi)
				//
				//  => (x'^2 / a_major^2) + (y'^2 / a_minor^2) = 1
				//  => b^2*x'^2 + a^2*y'^2 = a^2*b^2   (where a = a_major, b = a_minor)
				//
				// Expand and match to A x^2 + B x y + C y^2 + D x + E y + F = 0.

				double a2 = a_major * a_major; 
				double b2 = a_minor * a_minor; 
				double cosp = std::cos(phi);
				double sinp = std::sin(phi);

				// We'll build it in expanded form:
				//
				// b^2 * (dx*cos(phi) + dy*sin(phi))^2 +
				// a^2 * ( -dx*sin(phi) + dy*cos(phi) )^2 = a^2 * b^2
				//
				// dx = X - xc, dy = Y - yc

				// Let's define expansions for dx^2, dy^2, dx dy, etc.:
				//
				// b^2 [ dx^2 cos^2(phi) + 2 dx dy cos(phi) sin(phi) + dy^2 sin^2(phi) ]
				// + a^2 [ dx^2 sin^2(phi) - 2 dx dy sin(phi) cos(phi) + dy^2 cos^2(phi) ]
				// = a^2 b^2
				//
				// Group terms in X^2, Y^2, X Y, X, Y, constant. However, remember
				// dx = X - xc => X^2 - 2 X xc + xc^2, etc.
				//
				// It's easier to do it systematically with symbolic expansions or
				// by forming the 2x2 rotation-scaling matrix and offset. But let's do direct expansions carefully.

				// 1) We can form the "shape matrix" S in the local (X - xc, Y - yc) coords:
				//    M = R(phi) * diag(1/a_major^2, 1/a_minor^2) * R(phi)^T,
				//    where R(phi) is the rotation matrix.
				//
				//    Then the ellipse is [dx, dy]^T * M * [dx, dy] = 1.
				//    Expanding M gives us [ A  B/2 ]
				//                         [ B/2 C   ] in the (dx,dy) space.
				//    We then shift dx = X - xc, dy = Y - yc => incorporate the linear terms D, E, and constant F.

				// Let's do it with the matrix approach for clarity:
				Eigen::Matrix2d R;
				R <<  cosp, -sinp,
					sinp,  cosp;

				// diag(1/a_major^2, 1/a_minor^2)
				Eigen::Matrix2d invAxes;
				invAxes << 1.0/a2,  0.0,
						0.0,    1.0/b2;

				// M = R * invAxes * R^T
				Eigen::Matrix2d M = R * invAxes * R.transpose();

				// M = [ M00 M01 ]
				//     [ M01 M11 ]
				double M00 = M(0,0);
				double M01 = M(0,1);
				double M11 = M(1,1);

				// So the equation in local coords is:
				//   [dx dy] * M * [dx dy]^T = 1
				//
				// Expand: M00 dx^2 + 2 M01 dx dy + M11 dy^2 = 1
				//
				// Next we incorporate dx = X - xc, dy = Y - yc:
				//
				// => M00 (X - xc)^2 + 2 M01 (X - xc)(Y - yc) + M11 (Y - yc)^2 = 1
				//
				// Expand those squares to get the conic in X,Y.

				// We'll do an explicit expansion for:
				//
				// (X - xc)^2 = X^2 - 2X xc + xc^2
				// (Y - yc)^2 = Y^2 - 2Y yc + yc^2
				// (X - xc)(Y - yc) = XY - X yc - Y xc + xc yc

				// Coefficients for X^2, Y^2, XY
				double A_xy = M00;     // coefficient for (X - xc)^2
				double B_xy = 2*M01;   // will multiply (X - xc)(Y - yc)
				double C_xy = M11;     // coefficient for (Y - yc)^2

				// Expand the left side -> must = 1
				//
				// => A_xy (X^2 - 2X xc + xc^2)
				//  + B_xy (X Y - X yc - Y xc + xc yc)
				//  + C_xy (Y^2 - 2Y yc + yc^2)
				// = 1

				// We'll group them as:
				//
				// X^2 * A_xy
				// + Y^2 * C_xy
				// + XY    * B_xy
				//
				// + X [ -2 xc A_xy - yc B_xy ]
				// + Y [ -2 yc C_xy - xc B_xy ]
				//
				// + constant [ A_xy xc^2 + B_xy xc yc + C_xy yc^2 ]

				double A_ = A_xy;       // X^2
				double B_ = B_xy;       // X Y  (We want  B in the final eqn  as B x y, so it's B = B_xy)
				double C_ = C_xy;       // Y^2

				double D_ = -2.0 * xc * A_xy - yc * B_xy;            // coefficient of X
				double E_ = -2.0 * yc * C_xy - xc * B_xy;            // coefficient of Y
				double F_ = A_xy*xc*xc + B_xy*xc*yc + C_xy*yc*yc - 1.0;  // constant term, shift the " = 1 " to left => -1

				// Now we have:
				//   A_ X^2 + B_ X Y + C_ Y^2 + D_ X + E_ Y + F_ = 0
				//
				// That is the ellipse in the original XY-coordinates.

				A = A_;
				B = B_;
				C = C_;
				D = D_;
				E = E_;
				F = F_;
			}

			OLGA_INLINE bool EllipseP2N2C1BasedSolver::estimateModel(
				const cv::Mat& data_,
				const size_t *sample_,
				size_t sample_number_,
				std::vector<Model> &models_,
				const double *weights_) const
			{			
				if (sample_number_ < sampleSize())
					return false;

				const double idx1 = sample_ == nullptr ? 0 : sample_[0];
				const double idx2 = sample_ == nullptr ? 1 : sample_[1];

				Eigen::VectorXd data(9);
				data(0) = data_.at<double>(idx1, 0);
				data(1) = data_.at<double>(idx1, 1);
				data(2) = data_.at<double>(idx1, 2);
				data(3) = data_.at<double>(idx1, 3);
				data(4) = data_.at<double>(idx1, 4);
				data(5) = data_.at<double>(idx2, 0);
				data(6) = data_.at<double>(idx2, 1);
				data(7) = data_.at<double>(idx2, 2);
				data(8) = data_.at<double>(idx2, 3);
				Eigen::MatrixXcd sol = solver_ellipse_2PGC(data);
				
				int num_sols = 0;
				for(int i=0; i < 5; ++i)
				{
					//
					if(sol(i,0).imag() < -0.0001 || sol(i,0).imag() > 0.0001)
						continue;

					const double w1 = sol(0,i).real();
					const double w2 = sol(1,i).real();
					const double w3 = sol(2,i).real();
					const double w4 = sol(3,i).real();
					const double w5 = sol(4,i).real();

					if(w4 < 0 || w5 < 0)
						continue;

					const double phi_res = -std::atan(w1);

					Model model;
					model.descriptor.resize(11,1);

					double phi = phi_res;
					double cx = -std::cos(phi_res)*w2/std::sqrt(1+w1*w1) + std::sin(phi_res)*w3/std::sqrt(1+w1*w1);
					double cy = -std::sin(phi_res)*w2/std::sqrt(1+w1*w1) - std::cos(phi_res)*w3/std::sqrt(1+w1*w1);
					double a = std::sqrt(1/(w4*(1+w1*w1)));
					double b = std::sqrt(1/(w5*(1+w1*w1)));
					
					double a_major = a > b ? a : b;
					double a_minor = a > b ? b : a;

					ellipseParamToConic(cx, cy, a_major, a_minor, phi, 
						model.descriptor(0), model.descriptor(1), model.descriptor(2), model.descriptor(3), model.descriptor(4), model.descriptor(5));
						
					model.descriptor(6) = cx;
					model.descriptor(7) = cy;
					model.descriptor(8) = a_major;
					model.descriptor(9) = a_minor;
					model.descriptor(10) = phi;

					models_.push_back(model);
				}

				return models_.size() > 0;
				
			}
		}
	}
}